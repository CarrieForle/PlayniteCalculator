using System.Collections.Generic;
using System.Net.Http;
using System.Threading;
using System.Threading.Tasks;

namespace Calculator
{
	using static ApiCommon;

	public static class CurrencyApi
	{
		/// <summary>
		/// Look up the exchange rate of USD to the
		/// given currency. (i.e., 1 USD = ?? CUR)
		/// </summary>
		/// <param name="currency">Currency name</param>
		/// <returns>Exchange rate</returns>
		public static async Task<double> GetExchangeRate(HttpClient client, string currency, CancellationToken cancellationToken)
		{
			var currencyString = currency.ToString();
			var response = await IfCancelledThenTimeout(client.GetAsync($"https://currencyrateapi.com/api/latest?base=USD&codes={currencyString}", cancellationToken));
			await ThrowOnBadHttpStatus(response);
			var rate = await TryParse<ExchangeRate>(response, "Exchange rate");
			return rate.rates[currencyString.ToLower()];
		}

		public static async Task<double> GetExchangeRate(HttpClient client, Currency currency, CancellationToken cancellationToken)
		{
			return await GetExchangeRate(client, currency.ToString(), cancellationToken);
		}

		private class ExchangeRate
		{
			public Dictionary<string, double> rates;
		}
	}

	public enum Currency
	{
		USD,
		AED,
		AFN,
		ALL,
		AMD,
		ANG,
		AOA,
		ARS,
		ATS,
		AUD,
		AWG,
		AZM,
		AZN,
		BAM,
		BBD,
		BDT,
		BEF,
		BGN,
		BHD,
		BIF,
		BMD,
		BND,
		BOB,
		BRL,
		BSD,
		BTN,
		BWP,
		BYN,
		BYR,
		BZD,
		CAD,
		CDF,
		CHF,
		CLP,
		CNH,
		CNY,
		COP,
		CRC,
		CUC,
		CUP,
		CVE,
		CYP,
		CZK,
		DEM,
		DJF,
		DKK,
		DOP,
		DZD,
		EEK,
		EGP,
		ERN,
		ESP,
		ETB,
		EUR,
		FIM,
		FJD,
		FKP,
		FRF,
		GBP,
		GEL,
		GGP,
		GHC,
		GHS,
		GIP,
		GMD,
		GNF,
		GNS,
		GRD,
		GTQ,
		GYD,
		HKD,
		HNL,
		HRK,
		HTG,
		HUF,
		IDR,
		IEP,
		ILS,
		IMP,
		INR,
		IQD,
		IRR,
		ISK,
		ITL,
		JEP,
		JMD,
		JOD,
		JPY,
		KES,
		KGS,
		KHR,
		KMF,
		KPW,
		KRW,
		KWD,
		KYD,
		KZT,
		LAK,
		LBP,
		LKR,
		LRD,
		LSL,
		LTL,
		LUF,
		LVL,
		LYD,
		MAD,
		MDL,
		MGA,
		MGF,
		MKD,
		MMK,
		MNT,
		MOP,
		MRO,
		MRU,
		MTL,
		MUR,
		MVR,
		MWK,
		MXN,
		MXV,
		MYR,
		MZM,
		MZN,
		NAD,
		NGN,
		NIO,
		NLG,
		NOK,
		NPR,
		NZD,
		OMR,
		PAB,
		PEN,
		PGK,
		PHP,
		PKR,
		PLN,
		PLZ,
		PTE,
		PYG,
		QAR,
		ROL,
		RON,
		RSD,
		RUB,
		RWF,
		SAR,
		SBD,
		SCR,
		SDD,
		SDG,
		SEK,
		SGD,
		SHP,
		SIT,
		SKK,
		SLE,
		SLL,
		SOS,
		SRD,
		SRG,
		SSP,
		STD,
		STN,
		SVC,
		SYP,
		SZL,
		THB,
		TJS,
		TMM,
		TMT,
		TND,
		TOP,
		TRL,
		TRY,
		TTD,
		TVD,
		TWD,
		TZS,
		UAH,
		UGX,
		UYU,
		UZS,
		VEB,
		VED,
		VEF,
		VES,
		VND,
		VUV,
		WST,
		XAF,
		XAG,
		XAU,
		XCD,
		XCG,
		XDR,
		XOF,
		XPD,
		XPF,
		XPT,
		YER,
		ZAR,
		ZMK,
		ZMW,
		ZWD,
		ZWG,
		ZWL,
	}
}